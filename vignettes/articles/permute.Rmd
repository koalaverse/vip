---
title: "Permutation importance"
bibliography: ../references.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this article, we'll walk through some exmaples of using **vip** to compute [permutation-based variable importance (VI) scores](https://scikit-learn.org/stable/modules/permutation_importance.html). For further details and references, see @greenwell-2020-vip. To show how flexible this approach is, we'll compute VI scores from a random forest fit via the [ranger](https://cran.r-project.org/package=ranger) and [tidymodels](https://www.tidymodels.org/) packages.

For illustration we'll use the `attrition` data set from package [modeldata](https://cran.r-project.org/package=modeldata):

```{r atrrition}
data(attrition, package = "modeldata")
str(attrition)
```

The data contasin a mix of numeric, nominal factors, and ordered factors. The outcome of interest is a binary indicator of whether or not the employee "atritted" (i.e., left the company). For more details, see `?modeldata::attrition`.

```{r load-packages, message = FALSE}
library(tidymodels)

# Create a random forest specification
ranger_spec <- rand_forest(
  trees = 500,  # number of trees in forest
  mode = "classification",  # prediction mode (will return class labels)
  engine = "ranger"  # implementation to use
)

# Fit the resulting forest
(ranger_fit <- 
  workflow(Attrition ~ ., spec = ranger_spec) %>%
  fit(attrition))
```
You can list all the built-in metrics with `list_metrics()`:

```{r list-metrics}
library(vip)

list_metrics()
```

For this example, we'll use the [Brier score](https://en.wikipedia.org/wiki/Brier_score) as the performance metric; the Brier score measures the accuracy of the predicted probabilities and is used internally by **ranger** when building the individual trees. For the Brier score, smaller is better.

```{r}
brier_score <- function(pred, obs) {
  # Here, `obs` is the binary outcome coded as 0/1 and `pred` is the 
  # corresponding predictied probability of being a 1.
  mean((pred - obs) ^ 2)
}
```

```{r}
# Prediction wrapper that operates on "workflow" object
pred_fun <- function(object, newdata) {
  # Need to return a vector of predicted probabilities for the class of 
  # interest (i.e., not a data frame or matrix of probabilities)
  predict(object, newdata, type = "prob")$.pred_Yes
}

# Sanity check
prob.yes <- pred_fun(ranger_fit, newdata = attrition)
brier_score(prob.yes, ifelse(attrition$Attrition == "yes", 1, 0))
```
