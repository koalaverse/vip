<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Quentin D. Read" />

<meta name="date" content="2023-02-13" />

<title>Tooltips for ggalluvial plots in Shiny apps</title>

<script src="shiny_files/header-attrs-2.20/header-attrs.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="/Library/Frameworks/R.framework/Versions/4.2/Resources/library/rmarkdown/rmarkdown/templates/html_vignette/resources/vignette.css" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Tooltips for ggalluvial plots in Shiny
apps</h1>
<h4 class="author">Quentin D. Read</h4>
<h4 class="date">2023-02-13</h4>



<div id="section-problem" class="section level2">
<h2>Problem</h2>
<p>In an interactive visualization, it is visually cleaner and better
for interpretation if labels and other information appear as “tooltips”
when the user hovers over or clicks on elements of the plot, rather than
displaying all the labels on the plot at one time. However, the
{ggalluvial} package does not natively include this functionality. It is
possible to enable this using functions from several other packages.
This vignette illustrates how to create Shiny apps that display an
alluvial plot with tooltips that appear when the user hovers over two
different plot elements: strata created with <code>geom_stratum()</code>
and alluvia created with <code>geom_alluvium()</code>. An example is
provided for wide-format alluvial data (the <code>UCBAdmissions</code>
dataset) and long-format alluvial data (the <code>vaccinations</code>
dataset).</p>
<p>The tooltips that appear when the user hovers over elements of the
plot show a text label and the count in each group. If the user hovers
or clicks somewhere inside a ggplot panel, Shiny automatically returns
information about the location of the mouse cursor <em>in plot
coordinates</em>. That means the main work we have to do is to extract
or manually recalculate the coordinates of the different plot elements.
With that information, we can determine which plot element the cursor is
hovering over and display the appropriate information in the tooltip or
other output method.</p>
<p><em>Note:</em> The app demonstrated here depends on the packages
{htmltools} and {sp}, in addition of course to {ggalluvial} and {shiny}.
Please be aware that all of these packages will need to be installed on
the server where your Shiny app is running.</p>
<div id="section-hovering-over-and-clicking-on-strata"
class="section level3">
<h3>Hovering over and clicking on strata</h3>
<p>Enabling hovering over and clicking on strata is straightforward
because of their rectangular shape. We only need the minimum and maximum
<code>x</code> and <code>y</code> coordinates for each of the
rectangles. The rectangles are evenly spaced along the x-axis, centered
on positive integers beginning with 1. The width is set in
<code>geom_stratum()</code> so, for example, we know that the
x-coordinates of the first stratum are
<code>c(1 - width/2, 1 + width/2)</code>. The y-coordinates can be
determined from the number of rows in the input data multiplied by their
weights.</p>
</div>
<div id="section-hovering-over-and-clicking-on-alluvia"
class="section level3">
<h3>Hovering over and clicking on alluvia</h3>
<p>Hovering over and clicking on alluvia are more difficult because the
shapes of the alluvia are more complex. The default shape of the
polygons includes an <code>xspline</code> curve drawn using the {grid}
package. We need to manually reconstruct the coordinates of the
polygons, then use <code>sp::pointInPolygon()</code> to detect which, if
any, polygons the cursor is over.</p>
</div>
</div>
<div id="section-app-with-wide-format-alluvial-data"
class="section level2">
<h2>App with wide-format alluvial data</h2>
<p>The app is embedded below, followed by a walkthrough of the source
code.</p>
<iframe src="https://qdread.shinyapps.io/ex-shiny-wide-data" height="650" width="800">
</iframe>
<p>If you aren’t connected to the internet, or if you loaded this
vignette using <code>vignette('shiny', package = 'ggalluvial')</code>
rather than <code>browseVignettes(package = 'ggalluvial')</code>, the
app will not display in the window above. You can view the app locally
by running this line of code in your console:</p>
<div class="sourceCode" id="section-cb1"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb1-1"><a href="#section-cb1-1" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">shinyAppDir</span>(<span class="fu">system.file</span>(<span class="st">&quot;examples/ex-shiny-wide-data&quot;</span>, <span class="at">package=</span><span class="st">&quot;ggalluvial&quot;</span>))</span></code></pre></div>
</div>
<div id="section-structure-of-the-example-app" class="section level2">
<h2>Structure of the example app</h2>
<p>Here, we will go over each section of the code in detail. The full
source code is included in the package’s <code>examples</code>
directory.</p>
<p>The app first (1) loads the data and (2) builds the plot. Then, (3)
information is extracted from the built plot object to (4) manually
recalculate the coordinates of the polygons that make up the plot.
Internally, {ggalluvial} uses the {grid} package to draw the polygons,
so the next steps are (5) to define the minima and maxima of the x and y
axes in {grid} units and the units that appear on the plot’s coordinate
system, and (6) to convert the polygon coordinates from {grid} units
plot units. Next, the user interface is defined, including output of (7)
the plot image and (8) the tooltip. The final block of code is the
server function, which first (9) renders the plot. Finally, the tooltip
is defined. This includes (10) logic to determine whether the mouse
cursor is inside the plot panel, then (11) whether it is hovering over a
stratum, (12) an alluvium, or neither, based on the mouse coordinates
provided by Shiny. If the mouse is hovering over a plot element, the app
finds appropriate information and prints it in a small “tooltip” box
next to the mouse cursor (11b and 12b).</p>
<p>This is the structure of the app in pseudocode.</p>
<div class="sourceCode" id="section-cb2"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb2-1"><a href="#section-cb2-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&lt;(1) Load data.&gt;&#39;</span></span>
<span id="section-cb2-2"><a href="#section-cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb2-3"><a href="#section-cb2-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&lt;(2) Create &quot;ggplot&quot; object for alluvial plot and build it.&gt;&#39;</span></span>
<span id="section-cb2-4"><a href="#section-cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb2-5"><a href="#section-cb2-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&lt;(3) Extract data from built plot object used to create alluvium polygons.&gt;&#39;</span></span>
<span id="section-cb2-6"><a href="#section-cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb2-7"><a href="#section-cb2-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (polygon <span class="cf">in</span> polygons) {</span>
<span id="section-cb2-8"><a href="#section-cb2-8" aria-hidden="true" tabindex="-1"></a>     <span class="st">&#39;&lt;(4) Use polygon splines to generate coordinates of alluvium boundaries.&gt;&#39;</span></span>
<span id="section-cb2-9"><a href="#section-cb2-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="section-cb2-10"><a href="#section-cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb2-11"><a href="#section-cb2-11" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&lt;(5) Define range of coordinates in grid units and plot units.&gt;&#39;</span></span>
<span id="section-cb2-12"><a href="#section-cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb2-13"><a href="#section-cb2-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (polygon <span class="cf">in</span> polygons) {    </span>
<span id="section-cb2-14"><a href="#section-cb2-14" aria-hidden="true" tabindex="-1"></a>     <span class="st">&#39;&lt;(6) Convert coordinates from grid units to plot units.&gt;&#39;</span></span>
<span id="section-cb2-15"><a href="#section-cb2-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="section-cb2-16"><a href="#section-cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb2-17"><a href="#section-cb2-17" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="section-cb2-18"><a href="#section-cb2-18" aria-hidden="true" tabindex="-1"></a>     <span class="st">&#39;&lt;(7) Output plot with hovering enabled.&gt;&#39;</span></span>
<span id="section-cb2-19"><a href="#section-cb2-19" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="section-cb2-20"><a href="#section-cb2-20" aria-hidden="true" tabindex="-1"></a>     <span class="st">&#39;&lt;(8) Output tooltip.&gt;&#39;</span></span>
<span id="section-cb2-21"><a href="#section-cb2-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="section-cb2-22"><a href="#section-cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb2-23"><a href="#section-cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb2-24"><a href="#section-cb2-24" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session) {</span>
<span id="section-cb2-25"><a href="#section-cb2-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="section-cb2-26"><a href="#section-cb2-26" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>alluvial_plot <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="section-cb2-27"><a href="#section-cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;&lt;(9) Render the plot.&gt;&#39;</span></span>
<span id="section-cb2-28"><a href="#section-cb2-28" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="section-cb2-29"><a href="#section-cb2-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="section-cb2-30"><a href="#section-cb2-30" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>tooltip <span class="ot">&lt;-</span> <span class="fu">renderText</span>({</span>
<span id="section-cb2-31"><a href="#section-cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">&#39;&lt;(10) mouse cursor is within the plot panel&gt;&#39;</span>) {</span>
<span id="section-cb2-32"><a href="#section-cb2-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="st">&#39;&lt;(11) mouse cursor is within a stratum box&gt;&#39;</span>) {</span>
<span id="section-cb2-33"><a href="#section-cb2-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&lt;(11b) Render stratum tooltip.&gt;&#39;</span></span>
<span id="section-cb2-34"><a href="#section-cb2-34" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="section-cb2-35"><a href="#section-cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="st">&#39;&lt;(12) mouse cursor is within an alluvium polygon&gt;&#39;</span>) {</span>
<span id="section-cb2-36"><a href="#section-cb2-36" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;&lt;(12b) Render alluvium tooltip.&gt;&#39;</span></span>
<span id="section-cb2-37"><a href="#section-cb2-37" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="section-cb2-38"><a href="#section-cb2-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="section-cb2-39"><a href="#section-cb2-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="section-cb2-40"><a href="#section-cb2-40" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="section-cb2-41"><a href="#section-cb2-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="section-cb2-42"><a href="#section-cb2-42" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div id="section-loading-data" class="section level3">
<h3>Loading data</h3>
<p>The UC-Berkeley admissions dataset, <code>UCBAdmissions</code>, is
used in this example. After loading the necessary packages, the first
thing we do in the app is load the data and coerce from array to data
frame.</p>
<div class="sourceCode" id="section-cb3"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb3-1"><a href="#section-cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(UCBAdmissions)</span>
<span id="section-cb3-2"><a href="#section-cb3-2" aria-hidden="true" tabindex="-1"></a>ucb_admissions <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(UCBAdmissions)</span></code></pre></div>
<p>Next we set <code>offset</code>, the distance from cursor to tooltip,
in pixels, in both x and y directions. We also set
<code>node_width</code> and <code>alluvium_width</code> here, which are
used as arguments to <code>geom_stratum()</code> and
<code>geom_alluvium()</code> below, and again later to determine whether
the mouse cursor is hovering over a stratum/alluvium.</p>
<div class="sourceCode" id="section-cb4"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb4-1"><a href="#section-cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Offset, in pixels, for location of tooltip relative to mouse cursor,</span></span>
<span id="section-cb4-2"><a href="#section-cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># in both x and y direction.</span></span>
<span id="section-cb4-3"><a href="#section-cb4-3" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="section-cb4-4"><a href="#section-cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Width of node boxes</span></span>
<span id="section-cb4-5"><a href="#section-cb4-5" aria-hidden="true" tabindex="-1"></a>node_width <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span></span>
<span id="section-cb4-6"><a href="#section-cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Width of alluvia</span></span>
<span id="section-cb4-7"><a href="#section-cb4-7" aria-hidden="true" tabindex="-1"></a>alluvium_width <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span></span></code></pre></div>
</div>
<div id="section-drawing-the-plot-and-extracting-coordinates"
class="section level3">
<h3>Drawing the plot and extracting coordinates</h3>
<p>Next, we create the <code>ggplot</code> object for the alluvial plot,
then we call the <code>ggplot_build()</code> function to build the plot
without displaying it.</p>
<div class="sourceCode" id="section-cb5"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb5-1"><a href="#section-cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw plot.</span></span>
<span id="section-cb5-2"><a href="#section-cb5-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(ucb_admissions,</span>
<span id="section-cb5-3"><a href="#section-cb5-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> Freq, <span class="at">axis1 =</span> Gender, <span class="at">axis2 =</span> Dept)) <span class="sc">+</span> </span>
<span id="section-cb5-4"><a href="#section-cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_alluvium</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Admit), <span class="at">knot.pos =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">width =</span> alluvium_width) <span class="sc">+</span> </span>
<span id="section-cb5-5"><a href="#section-cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stratum</span>(<span class="at">width =</span> node_width, <span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="st">&#39;black&#39;</span>, <span class="at">color =</span> <span class="st">&#39;grey&#39;</span>) <span class="sc">+</span> </span>
<span id="section-cb5-6"><a href="#section-cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">after_stat</span>(stratum)), </span>
<span id="section-cb5-7"><a href="#section-cb5-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">stat =</span> <span class="st">&quot;stratum&quot;</span>, </span>
<span id="section-cb5-8"><a href="#section-cb5-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">reverse =</span> <span class="cn">TRUE</span>, </span>
<span id="section-cb5-9"><a href="#section-cb5-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">2</span>)) <span class="sc">+</span> </span>
<span id="section-cb5-10"><a href="#section-cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="section-cb5-11"><a href="#section-cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">type =</span> <span class="st">&quot;qual&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;Set1&quot;</span>) <span class="sc">+</span></span>
<span id="section-cb5-12"><a href="#section-cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="st">&quot;Gender&quot;</span>, <span class="st">&quot;Dept&quot;</span>), <span class="at">expand =</span> <span class="fu">c</span>(.<span class="dv">05</span>, .<span class="dv">05</span>)) <span class="sc">+</span></span>
<span id="section-cb5-13"><a href="#section-cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="section-cb5-14"><a href="#section-cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;UC Berkeley admissions and rejections&quot;</span>, <span class="st">&quot;by sex and department&quot;</span>) <span class="sc">+</span></span>
<span id="section-cb5-15"><a href="#section-cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">1</span>)),</span>
<span id="section-cb5-16"><a href="#section-cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">1</span>)),</span>
<span id="section-cb5-17"><a href="#section-cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&#39;bottom&#39;</span>)</span>
<span id="section-cb5-18"><a href="#section-cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb5-19"><a href="#section-cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the plot. </span></span>
<span id="section-cb5-20"><a href="#section-cb5-20" aria-hidden="true" tabindex="-1"></a>pbuilt <span class="ot">&lt;-</span> <span class="fu">ggplot_build</span>(p)</span></code></pre></div>
<p>Now for the hard part: reverse-engineering the coordinates of the
alluvia polygons. This makes use of <code>pbuilt$data[[1]]</code>, a
data frame with the individual elements of the alluvial plot. We add an
additional column for <code>width</code> using the value we set above,
then split the data frame by group (groups correspond to the individual
alluvium polygons). We apply the function
<code>data_to_alluvium()</code> to each element of the list to get the
coordinates of the “skeleton” of the x-spline curve. Then, we pass these
coordinates to the function <code>grid::xsplineGrob()</code> to fill in
the smooth spline curves and convert them into a {grid} object. We pass
the resulting object to <code>grid::xsplinePoints()</code>, which
converts back into numeric vectors. At this point we now have the
coordinates of the alluvium polygons. The object
<code>xspline_points</code> is a list with length equal to the number of
alluvium polygons in the plot. Each element of the list is a list with
elements <code>x</code> and <code>y</code>, which are numeric
vectors.</p>
<div class="sourceCode" id="section-cb6"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb6-1"><a href="#section-cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add width parameter, and then convert built plot data to xsplines</span></span>
<span id="section-cb6-2"><a href="#section-cb6-2" aria-hidden="true" tabindex="-1"></a>data_draw <span class="ot">&lt;-</span> <span class="fu">transform</span>(pbuilt<span class="sc">$</span>data[[<span class="dv">1</span>]], <span class="at">width =</span> alluvium_width)</span>
<span id="section-cb6-3"><a href="#section-cb6-3" aria-hidden="true" tabindex="-1"></a>groups_to_draw <span class="ot">&lt;-</span> <span class="fu">split</span>(data_draw, data_draw<span class="sc">$</span>group)</span>
<span id="section-cb6-4"><a href="#section-cb6-4" aria-hidden="true" tabindex="-1"></a>group_xsplines <span class="ot">&lt;-</span> <span class="fu">lapply</span>(groups_to_draw,</span>
<span id="section-cb6-5"><a href="#section-cb6-5" aria-hidden="true" tabindex="-1"></a>                         data_to_alluvium) </span>
<span id="section-cb6-6"><a href="#section-cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb6-7"><a href="#section-cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert xspline coordinates to grid object.</span></span>
<span id="section-cb6-8"><a href="#section-cb6-8" aria-hidden="true" tabindex="-1"></a>xspline_coords <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="section-cb6-9"><a href="#section-cb6-9" aria-hidden="true" tabindex="-1"></a>  group_xsplines,</span>
<span id="section-cb6-10"><a href="#section-cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(coords) grid<span class="sc">::</span><span class="fu">xsplineGrob</span>(<span class="at">x =</span> coords<span class="sc">$</span>x, </span>
<span id="section-cb6-11"><a href="#section-cb6-11" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">y =</span> coords<span class="sc">$</span>y, </span>
<span id="section-cb6-12"><a href="#section-cb6-12" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">shape =</span> coords<span class="sc">$</span>shape, </span>
<span id="section-cb6-13"><a href="#section-cb6-13" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">open =</span> <span class="cn">FALSE</span>)</span>
<span id="section-cb6-14"><a href="#section-cb6-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="section-cb6-15"><a href="#section-cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb6-16"><a href="#section-cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Use grid::xsplinePoints to draw the curve for each polygon</span></span>
<span id="section-cb6-17"><a href="#section-cb6-17" aria-hidden="true" tabindex="-1"></a>xspline_points <span class="ot">&lt;-</span> <span class="fu">lapply</span>(xspline_coords, grid<span class="sc">::</span>xsplinePoints)</span></code></pre></div>
<p>The coordinates we have are in {grid} plotting units but we need to
convert them into the same units as the axes on the plot. We do this by
determining the range of the x and y-axes in {grid} units
(<code>xrange_old</code> and <code>yrange_old</code>). Then we fix the
range of the x axis as 1 to the number of strata, adjusted by half the
alluvium width on each side. Next we fix the range of the y-axis to the
sum of the counts across all alluvia at one node.</p>
<div class="sourceCode" id="section-cb7"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb7-1"><a href="#section-cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the x and y axis limits in grid coordinates (old) and plot</span></span>
<span id="section-cb7-2"><a href="#section-cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># coordinates (new)</span></span>
<span id="section-cb7-3"><a href="#section-cb7-3" aria-hidden="true" tabindex="-1"></a>xrange_old <span class="ot">&lt;-</span> <span class="fu">range</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(</span>
<span id="section-cb7-4"><a href="#section-cb7-4" aria-hidden="true" tabindex="-1"></a>  xspline_points,</span>
<span id="section-cb7-5"><a href="#section-cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(pts) <span class="fu">as.numeric</span>(pts<span class="sc">$</span>x)</span>
<span id="section-cb7-6"><a href="#section-cb7-6" aria-hidden="true" tabindex="-1"></a>)))</span>
<span id="section-cb7-7"><a href="#section-cb7-7" aria-hidden="true" tabindex="-1"></a>yrange_old <span class="ot">&lt;-</span> <span class="fu">range</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(</span>
<span id="section-cb7-8"><a href="#section-cb7-8" aria-hidden="true" tabindex="-1"></a>  xspline_points,</span>
<span id="section-cb7-9"><a href="#section-cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(pts) <span class="fu">as.numeric</span>(pts<span class="sc">$</span>y)</span>
<span id="section-cb7-10"><a href="#section-cb7-10" aria-hidden="true" tabindex="-1"></a>)))</span>
<span id="section-cb7-11"><a href="#section-cb7-11" aria-hidden="true" tabindex="-1"></a>xrange_new <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> alluvium_width<span class="sc">/</span><span class="dv">2</span>, <span class="fu">max</span>(pbuilt<span class="sc">$</span>data[[<span class="dv">1</span>]]<span class="sc">$</span>x) <span class="sc">+</span> alluvium_width<span class="sc">/</span><span class="dv">2</span>) </span>
<span id="section-cb7-12"><a href="#section-cb7-12" aria-hidden="true" tabindex="-1"></a>yrange_new <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">sum</span>(pbuilt<span class="sc">$</span>data[[<span class="dv">2</span>]]<span class="sc">$</span>count[pbuilt<span class="sc">$</span>data[[<span class="dv">2</span>]]<span class="sc">$</span>x <span class="sc">==</span> <span class="dv">1</span>])) </span></code></pre></div>
<p>We define a function <code>new_range_transform()</code> inline and
apply it to each set of coordinates. This returns another list,
<code>polygon_coords</code>, with the same structure as
<code>xspline_points</code>. Now we have the coordinates of the polygons
in plot units!</p>
<div class="sourceCode" id="section-cb8"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb8-1"><a href="#section-cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define function to convert grid graphics coordinates to data coordinates</span></span>
<span id="section-cb8-2"><a href="#section-cb8-2" aria-hidden="true" tabindex="-1"></a>new_range_transform <span class="ot">&lt;-</span> <span class="cf">function</span>(x_old, range_old, range_new) {</span>
<span id="section-cb8-3"><a href="#section-cb8-3" aria-hidden="true" tabindex="-1"></a>  (x_old <span class="sc">-</span> range_old[<span class="dv">1</span>])<span class="sc">/</span>(range_old[<span class="dv">2</span>] <span class="sc">-</span> range_old[<span class="dv">1</span>]) <span class="sc">*</span></span>
<span id="section-cb8-4"><a href="#section-cb8-4" aria-hidden="true" tabindex="-1"></a>    (range_new[<span class="dv">2</span>] <span class="sc">-</span> range_new[<span class="dv">1</span>]) <span class="sc">+</span> range_new[<span class="dv">1</span>]</span>
<span id="section-cb8-5"><a href="#section-cb8-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="section-cb8-6"><a href="#section-cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="section-cb8-7"><a href="#section-cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the x and y limits, convert the grid coordinates into plot coordinates.</span></span>
<span id="section-cb8-8"><a href="#section-cb8-8" aria-hidden="true" tabindex="-1"></a>polygon_coords <span class="ot">&lt;-</span> <span class="fu">lapply</span>(xspline_points, <span class="cf">function</span>(pts) {</span>
<span id="section-cb8-9"><a href="#section-cb8-9" aria-hidden="true" tabindex="-1"></a>  x_trans <span class="ot">&lt;-</span> <span class="fu">new_range_transform</span>(<span class="at">x_old =</span> <span class="fu">as.numeric</span>(pts<span class="sc">$</span>x), </span>
<span id="section-cb8-10"><a href="#section-cb8-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">range_old =</span> xrange_old, </span>
<span id="section-cb8-11"><a href="#section-cb8-11" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">range_new =</span> xrange_new)</span>
<span id="section-cb8-12"><a href="#section-cb8-12" aria-hidden="true" tabindex="-1"></a>  y_trans <span class="ot">&lt;-</span> <span class="fu">new_range_transform</span>(<span class="at">x_old =</span> <span class="fu">as.numeric</span>(pts<span class="sc">$</span>y), </span>
<span id="section-cb8-13"><a href="#section-cb8-13" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">range_old =</span> yrange_old, </span>
<span id="section-cb8-14"><a href="#section-cb8-14" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">range_new =</span> yrange_new)</span>
<span id="section-cb8-15"><a href="#section-cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">x =</span> x_trans, <span class="at">y =</span> y_trans)</span>
<span id="section-cb8-16"><a href="#section-cb8-16" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
</div>
<div id="section-user-interface" class="section level3">
<h3>User interface</h3>
<p>The app includes a minimal user interface with two output
elements.</p>
<div class="sourceCode" id="section-cb9"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb9-1"><a href="#section-cb9-1" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="section-cb9-2"><a href="#section-cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fluidRow</span>(tags<span class="sc">$</span><span class="fu">div</span>(</span>
<span id="section-cb9-3"><a href="#section-cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="st">&quot;position: relative;&quot;</span>,</span>
<span id="section-cb9-4"><a href="#section-cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plotOutput</span>(<span class="st">&quot;alluvial_plot&quot;</span>, <span class="at">height =</span> <span class="st">&quot;650px&quot;</span>, </span>
<span id="section-cb9-5"><a href="#section-cb9-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">hover =</span> <span class="fu">hoverOpts</span>(<span class="at">id =</span> <span class="st">&quot;plot_hover&quot;</span>)</span>
<span id="section-cb9-6"><a href="#section-cb9-6" aria-hidden="true" tabindex="-1"></a>               ),</span>
<span id="section-cb9-7"><a href="#section-cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">htmlOutput</span>(<span class="st">&quot;tooltip&quot;</span>)))</span>
<span id="section-cb9-8"><a href="#section-cb9-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The elements are:</p>
<ul>
<li>a <code>plotOutput</code> with the argument <code>hover</code>
defined, to enable behavior determined by the cursor’s plot coordinates
whenever the user hovers over the plot.</li>
<li>an <code>htmlOutput</code> for the tooltip that appears next to the
cursor on hover.</li>
</ul>
<p>The elements are wrapped in a <code>fluidRow()</code> and a
<code>div()</code> tag.</p>
<p><em>Note:</em> This vignette only illustrates how to display output
when the user hovers over an element. If you want to display output when
the user clicks on an element, the corresponding argument to
<code>plotOutput()</code> is
<code>click = clickOpts(id = "plot_click")</code>. This will return the
location of the mouse cursor in plot coordinates when the user clicks
somewhere within the plot panel.</p>
<p><em>Also Note:</em> In the example presented here, all of the plot
drawing and coordinate extracting code is outside the
<code>server()</code> function, because the plot itself does not change
with user input. However if you are building an app where the plot
changes in response to user input, for example a menu of options of
which variables to display, the plot drawing code has to be inside the
<code>renderPlot()</code> expression. This means that the coordinates
may need to be recalculated each time the user input changes as well. In
that case, you may need to use the global assignment operator
<code>&lt;&lt;-</code> so that the coordinates are accessible outside
the <code>renderPlot()</code> expression.</p>
</div>
<div id="section-server-function" class="section level3">
<h3>Server function</h3>
<p>In the server function, we first call <code>renderPlot()</code> to
draw the plot in the app window.</p>
<div class="sourceCode" id="section-cb10"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb10-1"><a href="#section-cb10-1" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>alluvial_plot <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>(p, <span class="at">res =</span> <span class="dv">200</span>)</span></code></pre></div>
<p>Next, we define the tooltip with a <code>renderText()</code>
expression. Within that expression, we first extract the cursor’s plot
coordinates from the user input. We determine whether the cursor is
hovering over a stratum and if so, display the appropriate tooltip.</p>
<div class="figure">
<img
src="https://raw.githubusercontent.com/corybrunson/ggalluvial/main/vignettes/img/hover_stratum.png"
alt="" />
<p class="caption">screenshot of tooltip on stratum</p>
</div>
<p>If the mouse cursor is not hovering over a stratum, we determine
whether it is hovering over an alluvium polygon and if so, display
different information in the tooltip.</p>
<div class="figure">
<img
src="https://raw.githubusercontent.com/corybrunson/ggalluvial/main/vignettes/img/hover_alluvium.png"
alt="" />
<p class="caption">screenshot of tooltip on alluvium</p>
</div>
<p>If the mouse cursor is hovering over an empty region of the plot,
<code>renderText()</code> returns nothing and no tooltip appears.</p>
<div class="figure">
<img
src="https://raw.githubusercontent.com/corybrunson/ggalluvial/main/vignettes/img/hover_empty_area.png"
alt="" />
<p class="caption">screenshot of cursor over empty region</p>
</div>
<p>Let’s take a deeper dive into the logic used to determine the text
that appears in the tooltip.</p>
<p>First, we check whether the cursor is inside the plot panel. If it is
not, the element <code>plot_hover</code> of the input will be
<code>NULL</code>. In that case <code>renderText()</code> will return
nothing and no tooltip will appear.</p>
<div class="sourceCode" id="section-cb11"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb11-1"><a href="#section-cb11-1" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>tooltip <span class="ot">&lt;-</span> <span class="fu">renderText</span>(</span>
<span id="section-cb11-2"><a href="#section-cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(input<span class="sc">$</span>plot_hover)) { ... }</span>
<span id="section-cb11-3"><a href="#section-cb11-3" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="section-cb11-4"><a href="#section-cb11-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div id="section-hovering-over-a-stratum" class="section level4">
<h4>Hovering over a stratum</h4>
<p>Next, we check whether the cursor is over a stratum. We round the
x-coordinate of the mouse cursor in data units to the nearest integer,
then determine whether the x-coordinate is within
<code>node_width/2</code> of that integer. If so, the mouse cursor is
horizontally within the box. Here the <code>if</code>-<code>else</code>
statement includes behavior to display the tooltip for a stratum if
true, and an alluvium if false.</p>
<div class="sourceCode" id="section-cb12"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb12-1"><a href="#section-cb12-1" aria-hidden="true" tabindex="-1"></a>hover <span class="ot">&lt;-</span> input<span class="sc">$</span>plot_hover</span>
<span id="section-cb12-2"><a href="#section-cb12-2" aria-hidden="true" tabindex="-1"></a>x_coord <span class="ot">&lt;-</span> <span class="fu">round</span>(hover<span class="sc">$</span>x)</span>
<span id="section-cb12-3"><a href="#section-cb12-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="section-cb12-4"><a href="#section-cb12-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">abs</span>(hover<span class="sc">$</span>x <span class="sc">-</span> x_coord) <span class="sc">&lt;</span> (node_width <span class="sc">/</span> <span class="dv">2</span>)) { ... } <span class="cf">else</span> { ... }</span></code></pre></div>
<p>If the condition is true, we need to find the index of the row of the
input data that goes with the stratum the cursor is on. The data frame
<code>pbuilt$data[[2]]</code> includes columns <code>x</code>,
<code>ymin</code>, and <code>ymax</code> that define the x-coordinate of
the center of the stratum, and the minimum and maximum y-coordinates of
the stratum. We find the row index of that data frame where
<code>x</code> is equal to the rounded x-coordinate of the cursor, and
the y-coordinate of the cursor falls between <code>ymin</code> and
<code>ymax</code>.</p>
<div class="sourceCode" id="section-cb13"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb13-1"><a href="#section-cb13-1" aria-hidden="true" tabindex="-1"></a>node_row <span class="ot">&lt;-</span> </span>
<span id="section-cb13-2"><a href="#section-cb13-2" aria-hidden="true" tabindex="-1"></a>  pbuilt<span class="sc">$</span>data[[<span class="dv">2</span>]]<span class="sc">$</span>x <span class="sc">==</span> x_coord <span class="sc">&amp;</span> hover<span class="sc">$</span>y <span class="sc">&gt;</span> pbuilt<span class="sc">$</span>data[[<span class="dv">2</span>]]<span class="sc">$</span>ymin <span class="sc">&amp;</span> hover<span class="sc">$</span>y <span class="sc">&lt;</span> pbuilt<span class="sc">$</span>data[[<span class="dv">2</span>]]<span class="sc">$</span>ymax</span></code></pre></div>
<p>To find the information to display in the tooltip, we get the name of
the stratum as well as its width from the data in
<code>pbuilt</code>.</p>
<div class="sourceCode" id="section-cb14"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb14-1"><a href="#section-cb14-1" aria-hidden="true" tabindex="-1"></a>node_label <span class="ot">&lt;-</span> pbuilt<span class="sc">$</span>data[[<span class="dv">2</span>]]<span class="sc">$</span>stratum[node_row]</span>
<span id="section-cb14-2"><a href="#section-cb14-2" aria-hidden="true" tabindex="-1"></a>node_n <span class="ot">&lt;-</span> pbuilt<span class="sc">$</span>data[[<span class="dv">2</span>]]<span class="sc">$</span>count[node_row]</span></code></pre></div>
<p>Finally, we render a tooltip using the <code>div</code> tag. We
provide the text to display as arguments to
<code>htmltools::renderTags()</code>. We also paste CSS style
information together and pass it to the <code>style</code> argument.
Note that the tooltip positioning is provided in CSS coordinates
(pixels), not data coordinates. This does not require any additional
effort on our part because <code>plot_hover</code> also includes an
element called <code>coords_css</code>, which contains the mouse cursor
location in pixel units.</p>
<div class="sourceCode" id="section-cb15"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb15-1"><a href="#section-cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">renderTags</span>(</span>
<span id="section-cb15-2"><a href="#section-cb15-2" aria-hidden="true" tabindex="-1"></a>  tags<span class="sc">$</span><span class="fu">div</span>(</span>
<span id="section-cb15-3"><a href="#section-cb15-3" aria-hidden="true" tabindex="-1"></a>    node_label, tags<span class="sc">$</span><span class="fu">br</span>(),</span>
<span id="section-cb15-4"><a href="#section-cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;n =&quot;</span>, node_n,</span>
<span id="section-cb15-5"><a href="#section-cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">paste0</span>(</span>
<span id="section-cb15-6"><a href="#section-cb15-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;position: absolute; &quot;</span>,</span>
<span id="section-cb15-7"><a href="#section-cb15-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;top: &quot;</span>, hover<span class="sc">$</span>coords_css<span class="sc">$</span>y <span class="sc">+</span> offset, <span class="st">&quot;px; &quot;</span>,</span>
<span id="section-cb15-8"><a href="#section-cb15-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;left: &quot;</span>, hover<span class="sc">$</span>coords_css<span class="sc">$</span>x <span class="sc">+</span> offset, <span class="st">&quot;px; &quot;</span>,</span>
<span id="section-cb15-9"><a href="#section-cb15-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;background: gray; &quot;</span>,</span>
<span id="section-cb15-10"><a href="#section-cb15-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;padding: 3px; &quot;</span>,</span>
<span id="section-cb15-11"><a href="#section-cb15-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;color: white; &quot;</span></span>
<span id="section-cb15-12"><a href="#section-cb15-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="section-cb15-13"><a href="#section-cb15-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="section-cb15-14"><a href="#section-cb15-14" aria-hidden="true" tabindex="-1"></a>)<span class="sc">$</span>html</span></code></pre></div>
</div>
<div id="section-hovering-over-an-alluvium" class="section level4">
<h4>Hovering over an alluvium</h4>
<p>If the cursor is not over a stratum, the next nested
<code>if</code>-statement checks whether it is over an alluvium. This is
done using the function <code>sp::point.in.polygon()</code> applied
across each of the polygons for which we defined the coordinates inside
the <code>renderPlot()</code> expression.</p>
<div class="sourceCode" id="section-cb16"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb16-1"><a href="#section-cb16-1" aria-hidden="true" tabindex="-1"></a>hover_within_flow <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="section-cb16-2"><a href="#section-cb16-2" aria-hidden="true" tabindex="-1"></a>  polygon_coords,</span>
<span id="section-cb16-3"><a href="#section-cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(pol) <span class="fu">point.in.polygon</span>(<span class="at">point.x =</span> hover<span class="sc">$</span>x, </span>
<span id="section-cb16-4"><a href="#section-cb16-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">point.y =</span> hover<span class="sc">$</span>y, </span>
<span id="section-cb16-5"><a href="#section-cb16-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">pol.x =</span> pol<span class="sc">$</span>x, </span>
<span id="section-cb16-6"><a href="#section-cb16-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">pol.y =</span> pol<span class="sc">$</span>y)</span>
<span id="section-cb16-7"><a href="#section-cb16-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>If at least one polygon is beneath the mouse cursor, we locate the
corresponding row in the input data and extract information to display
in the tooltip. (If the condition is not met, that means the cursor is
hovering over an empty area of the plot, so no tooltip appears.)</p>
<div class="sourceCode" id="section-cb17"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb17-1"><a href="#section-cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(hover_within_flow)) { ... }</span></code></pre></div>
<p>In the situation where there are more than one polygon overlapping,
we get the information for the polygon that is plotted last by calling
<code>rev()</code> on the logical vector returned by
<code>point.in.polygon()</code>. This means that the tooltip will
display information from the alluvium that appears “on top” in the plot.
In this example, we display the names of the nodes that the alluvium
connects, with arrows between them, and the width of the alluvium.</p>
<div class="sourceCode" id="section-cb18"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb18-1"><a href="#section-cb18-1" aria-hidden="true" tabindex="-1"></a>coord_id <span class="ot">&lt;-</span> <span class="fu">rev</span>(<span class="fu">which</span>(hover_within_flow <span class="sc">==</span> <span class="dv">1</span>))[<span class="dv">1</span>]</span>
<span id="section-cb18-2"><a href="#section-cb18-2" aria-hidden="true" tabindex="-1"></a>flow_label <span class="ot">&lt;-</span> <span class="fu">paste</span>(groups_to_draw[[coord_id]]<span class="sc">$</span>stratum, <span class="at">collapse =</span> <span class="st">&#39; -&gt; &#39;</span>)</span>
<span id="section-cb18-3"><a href="#section-cb18-3" aria-hidden="true" tabindex="-1"></a>flow_n <span class="ot">&lt;-</span> groups_to_draw[[coord_id]]<span class="sc">$</span>count[<span class="dv">1</span>]</span></code></pre></div>
<p>We render a tooltip using identical syntax to the one above.</p>
<div class="sourceCode" id="section-cb19"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb19-1"><a href="#section-cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">renderTags</span>(</span>
<span id="section-cb19-2"><a href="#section-cb19-2" aria-hidden="true" tabindex="-1"></a>  tags<span class="sc">$</span><span class="fu">div</span>(</span>
<span id="section-cb19-3"><a href="#section-cb19-3" aria-hidden="true" tabindex="-1"></a>    flow_label, tags<span class="sc">$</span><span class="fu">br</span>(),</span>
<span id="section-cb19-4"><a href="#section-cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;n =&quot;</span>, flow_n,</span>
<span id="section-cb19-5"><a href="#section-cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">paste0</span>(</span>
<span id="section-cb19-6"><a href="#section-cb19-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;position: absolute; &quot;</span>,</span>
<span id="section-cb19-7"><a href="#section-cb19-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;top: &quot;</span>, hover<span class="sc">$</span>coords_css<span class="sc">$</span>y <span class="sc">+</span> offset, <span class="st">&quot;px; &quot;</span>,</span>
<span id="section-cb19-8"><a href="#section-cb19-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;left: &quot;</span>, hover<span class="sc">$</span>coords_css<span class="sc">$</span>x <span class="sc">+</span> offset, <span class="st">&quot;px; &quot;</span>,</span>
<span id="section-cb19-9"><a href="#section-cb19-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;background: gray; &quot;</span>,</span>
<span id="section-cb19-10"><a href="#section-cb19-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;padding: 3px; &quot;</span>,</span>
<span id="section-cb19-11"><a href="#section-cb19-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;color: white; &quot;</span></span>
<span id="section-cb19-12"><a href="#section-cb19-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="section-cb19-13"><a href="#section-cb19-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="section-cb19-14"><a href="#section-cb19-14" aria-hidden="true" tabindex="-1"></a>)<span class="sc">$</span>html</span></code></pre></div>
</div>
</div>
</div>
<div id="section-app-with-long-format-alluvial-data"
class="section level2">
<h2>App with long-format alluvial data</h2>
<p>The <code>vaccinations</code> dataset is used for long-format
alluvial data. The app is embedded at the bottom of this document, but
we don’t need to walk through the source code because it’s almost
identical to the code above. The output of <code>ggplot_build()</code>
that is used to find the polygon coordinates and information for the
tooltips has a consistent structure regardless of the initial format of
the input data. Therefore, the calculation of polygon coordinates, user
interface, and server functions of the two apps are identical. The only
difference is in the initial creation of the <code>ggplot()</code>
object. Refer back to the <a href="ggalluvial.html">primary vignette</a>
for several example plots made both with long and with wide data.</p>
<p>The app is embedded below.</p>
<iframe src="https://qdread.shinyapps.io/ex-shiny-long-data" height="650" width="800">
</iframe>
<p>Again, if the app doesn’t display in the window above for whatever
reason, you can view it locally by running this line of code in your
console:</p>
<div class="sourceCode" id="section-cb20"><pre
class="sourceCode r"><code class="sourceCode r"><span id="section-cb20-1"><a href="#section-cb20-1" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">shinyAppDir</span>(<span class="fu">system.file</span>(<span class="st">&quot;examples/ex-shiny-long-data&quot;</span>, <span class="at">package=</span><span class="st">&quot;ggalluvial&quot;</span>))</span></code></pre></div>
</div>
<div id="section-conclusion" class="section level2">
<h2>Conclusion</h2>
<p>This vignette demonstrates how to enable tooltips for {ggalluvial}
plots in Shiny apps. This is one of many possible ways to do that. It
may not be the optimal way — other solutions are certainly possible!</p>
<p>The full source code for both of these Shiny apps is included with
the {ggalluvial} package in the ‘examples’ subdirectory where the
package is installed: the source files are
<code>ggalluvial/examples/ex-shiny-wide-data/app.R</code> and
<code>ggalluvial/examples/ex-shiny-long-data/app.R</code>.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
